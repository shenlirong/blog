import{useLocale as Z,isPlainObject as ee,isString as se}from"@vuepress/helper/client";import{useLocalStorage as j,useDebounceFn as le,watchImmediate as re,useEventListener as te}from"@vueuse/core";import{ref as A,computed as x,shallowRef as ae,onMounted as ie,onUnmounted as oe,defineComponent as ue,toRef as ce,reactive as ne,h as e,watch as ve}from"vue";import{useData as de,useRouter as me,useRouteLocale as he,RouteLink as M}from"vuepress/client";import{o as Q,u as pe,c as ye,l as fe,a as ge}from"../index-CSn1g7ic.js";import{S as He,T as Re,H as Se,a as be,b as U,C as $}from"../icons-DxmX1gti.js";import"../styles/search-result.css";import{store as xe}from"@temp/slimsearch/store.js";import"vuepress/shared";const Qe="SLIMSEARCH_QUERY_HISTORY",f=j(Qe,[]),ke=()=>{const{queryHistoryCount:r}=Q,t=r>0;return{enabled:t,queryHistories:f,addQueryHistory:i=>{t&&(f.value=Array.from(new Set([i,...f.value.slice(0,r-1)])))},removeQueryHistory:i=>{f.value=[...f.value.slice(0,i),...f.value.slice(i+1)]}}},E=r=>xe[r.id]+("anchor"in r?`#${r.anchor}`:""),Ce="SLIMSEARCH_RESULT_HISTORY",{resultHistoryCount:_}=Q,g=j(Ce,[]),qe=()=>{const r=_>0;return{enabled:r,resultHistories:g,addResultHistory:t=>{if(r){const i={link:E(t),display:t.display};"header"in t&&(i.header=t.header),g.value=[i,...g.value.slice(0,_-1)]}},removeResultHistory:t=>{g.value=[...g.value.slice(0,t),...g.value.slice(t+1)]}}},we=r=>{const{page:t,routeLocale:i}=de(),k=pe(),a=A(0),R=x(()=>a.value>0),p=ae([]);return ie(()=>{const{search:y,terminate:C}=ye(),H=le(n=>{const{resultsFilter:S=u=>u,querySplitter:F,suggestionsFilter:q,...w}=k.value;n?(a.value+=1,y(n,i.value,w).then(u=>S(u,n,i.value,t.value)).then(u=>{a.value-=1,p.value=u}).catch(u=>{console.warn(u),a.value-=1,a.value||(p.value=[])})):p.value=[]},Q.searchDelay-Q.suggestDelay,{maxWait:5e3});re([r,i],([n])=>H(n.join(" "))),oe(()=>{C()})}),{isSearching:R,results:p}};var Le=ue({name:"SearchResult",props:{queries:{type:Array,required:!0},isFocusing:Boolean},emits:["close","updateQuery"],setup(r,{emit:t}){const i=me(),k=he(),a=Z(fe),{enabled:R,addQueryHistory:p,queryHistories:y,removeQueryHistory:C}=ke(),{enabled:H,resultHistories:n,addResultHistory:S,removeResultHistory:F}=qe(),q=R||H,w=ce(r,"queries"),{results:u,isSearching:P}=we(w),o=ne({isQuery:!0,index:0}),d=A(0),m=A(0),T=x(()=>q&&(y.value.length>0||n.value.length>0)),L=x(()=>u.value.length>0),I=x(()=>u.value[d.value]||null),W=()=>{const{isQuery:s,index:l}=o;l===0?(o.isQuery=!s,o.index=s?n.value.length-1:y.value.length-1):o.index=l-1},Y=()=>{const{isQuery:s,index:l}=o;l===(s?y.value.length-1:n.value.length-1)?(o.isQuery=!s,o.index=0):o.index=l+1},B=()=>{d.value=d.value>0?d.value-1:u.value.length-1,m.value=I.value.contents.length-1},N=()=>{d.value=d.value<u.value.length-1?d.value+1:0,m.value=0},K=()=>{m.value<I.value.contents.length-1?m.value+=1:N()},V=()=>{m.value>0?m.value-=1:B()},D=s=>s.map(l=>se(l)?l:e(l[0],l[1])),z=s=>{if(s.type==="customField"){const l=ge[s.index]||"$content",[h,c=""]=ee(l)?l[k.value].split("$content"):l.split("$content");return s.display.map(v=>e("div",D([h,...v,c])))}return s.display.map(l=>e("div",D(l)))},b=()=>{d.value=0,m.value=0,t("updateQuery",""),t("close")},G=()=>R?e("div",{class:"slimsearch-records"},e("div",{class:"slimsearch-record"},[e("div",{class:"slimsearch-record-title"},a.value.queryHistory),e("ul",{class:"slimsearch-record-contents",role:"listbox"},y.value.map((s,l)=>{const h=o.isQuery&&o.index===l;return e("li",{class:["slimsearch-record-matches",{active:h}],role:"option","aria-selected":h,onClick:()=>{t("updateQuery",s)}},e("div",[e(U,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},s),e("button",{type:"button",class:"slimsearch-remove-icon",title:a.value.remove,"aria-label":a.value.remove,innerHTML:$,onClick:c=>{c.preventDefault(),c.stopPropagation(),C(l)}})]))}))])):null,J=()=>H?e("ul",{class:"slimsearch-records"},e("li",{class:"slimsearch-record"},[e("div",{class:"slimsearch-record-title"},a.value.resultHistory),e("ul",{class:"slimsearch-record-contents",role:"listbox"},n.value.map((s,l)=>{const h=!o.isQuery&&o.index===l;return e("li",{class:["slimsearch-record-matches",{active:h}],role:"option","aria-selected":h},e(M,{to:s.link,onClick:()=>{b()}},()=>[e(U,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},[s.header?e("div",{class:"slimsearch-record-content-header"},s.header):null,e("div",s.display.map(c=>D(c)).flat())]),e("button",{type:"button",class:"slimsearch-remove-icon",title:a.value.remove,"aria-label":a.value.remove,innerHTML:$,onClick:c=>{c.preventDefault(),c.stopPropagation(),F(l)}})]))}))])):null;return te("keydown",s=>{if(r.isFocusing){if(L.value){if(s.key==="ArrowUp")V();else if(s.key==="ArrowDown")K();else if(s.key==="Enter"){const l=I.value.contents[m.value];p(r.queries.join(" ")),S(l),i.push(E(l)),b()}}else if(H){if(s.key==="ArrowUp")W();else if(s.key==="ArrowDown")Y();else if(s.key==="Enter"){const{index:l}=o;o.isQuery?(s.preventDefault(),t("updateQuery",y.value[l])):(i.push(n.value[l].link),b())}}}}),ve([d,m],()=>{document.querySelector(".slimsearch-record.active .slimsearch-record-matches.active")?.scrollIntoView(!1)},{flush:"post"}),()=>e("div",{id:"slimsearch-results",class:["slimsearch-result-wrapper",{empty:r.queries.length?!L.value:!T.value}]},r.queries.length?P.value?e(He,{hint:a.value.searching}):L.value?e("div",{class:"slimsearch-records",role:"listbox","aria-labeledby":"slimsearch-label"},u.value.map(({title:s,contents:l},h)=>{const c=d.value===h;return e("div",{class:["slimsearch-record",{active:c}],role:"group","aria-selected":c},[e("div",{class:"slimsearch-record-title"},s||a.value.defaultTitle),e("ul",{class:"slimsearch-record-contents"},l.map((v,X)=>{const O=c&&m.value===X;return e("li",{class:["slimsearch-record-matches",{active:O}],role:"option","aria-selected":O},e(M,{to:E(v),onClick:()=>{p(r.queries.join(" ")),S(v),b()}},()=>[v.type==="text"?null:e(v.type==="title"?Re:v.type==="heading"?Se:be,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},[v.type==="text"&&v.header?e("div",{class:"slimsearch-record-content-header"},v.header):null,e("div",z(v))])]))}))])})):a.value.emptyResult:q?T.value?[G(),J()]:a.value.emptyHistory:a.value.emptyResult)}});export{Le as default};
//# sourceMappingURL=SearchResult.js.map
